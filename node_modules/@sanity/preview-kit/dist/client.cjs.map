{"version":3,"file":"client.cjs","sources":["../src/client/editIntent.ts","../src/client/transcode.ts","../src/client/request.ts","../src/client/mapToEditLinks.ts","../src/client/createClient.ts"],"sourcesContent":["import {\n  ContentSourceMapDocument,\n  ContentSourceMapDocuments,\n} from '@sanity/client'\n\nimport { parseNormalisedJsonPath } from './jsonpath'\nimport type { PathSegment, StudioUrl } from './types'\n\n/** @alpha */\nexport type EditLink = `/intent/edit/id=${string};path=${string}`\n/** @alpha */\nexport interface EditLinkProps {\n  studioUrl: StudioUrl\n  document: ContentSourceMapDocument\n}\n/** @alpha */\nexport type DefineEditLink = (\n  studioUrl: StudioUrl\n) => (\n  sourceDocument: ContentSourceMapDocuments[number]\n) => `${StudioUrl}${EditLink}`\n\n/** @alpha */\nexport function defineEditLink(\n  _studioUrl: StudioUrl\n): (\n  sourceDocument: ContentSourceMapDocuments[number],\n  path: string | PathSegment[]\n) => string {\n  const studioUrl = _studioUrl.replace(/\\/$/, '')\n  return (sourceDocument, path) =>\n    `${studioUrl}/intent/edit/id=${\n      sourceDocument._id\n    };path=${encodeJsonPathToUriComponent(path)}`\n}\n\n/** @alpha */\nexport function encodeJsonPathToUriComponent(\n  path: string | PathSegment[]\n): string {\n  const sourcePath = Array.isArray(path) ? path : parseNormalisedJsonPath(path)\n  return encodeURIComponent(\n    sourcePath\n      .map((key, i) =>\n        // eslint-disable-next-line no-nested-ternary\n        typeof key === 'number' ? `[${key}]` : i > 0 ? `.${key}` : key\n      )\n      .join('')\n  )\n}\n","/* eslint-disable no-nested-ternary */\nimport type { ContentSourceMapDocuments } from '@sanity/client'\nimport { vercelStegaCombine } from '@vercel/stega'\n\nimport { defineEditLink } from './editIntent'\nimport { parseNormalisedJsonPath } from './jsonpath'\nimport { encode } from './sourcemap'\nimport type {\n  ContentSourceMapQueryResponse,\n  Logger,\n  PathSegment,\n} from './types'\nimport type { FilterDefault, PreviewKitClientConfig } from './types'\n\nconst filterDefault: FilterDefault = ({ path }) => {\n  const endPath = path.at(-1)\n  // Never encode slugs\n  if (path.at(-2) === 'slug' && endPath === 'current') {\n    return false\n  }\n\n  // Skip underscored keys, needs better heuristics but it works for now\n  if (typeof endPath === 'string' && endPath.startsWith('_')) {\n    return false\n  }\n\n  /**\n   * Best effort infer Portable Text paths that should not be encoded.\n   * Nothing is for certain, and the below implementation may cause paths that aren't Portable Text and otherwise be safe to encode to be skipped.\n   * However, that's ok as userland can always opt-in with the `encodeSourceMapAtPath` option and mark known safe paths as such, which will override this heuristic.\n   */\n  // If the path ends in [number].children[number].marks[number] it's likely a PortableTextSpan: https://github.com/portabletext/types/blob/e54eb24f136d8efd51a46c6a190e7c46e79b5380/src/portableText.ts#LL154C16-L154C16\n  if (\n    typeof endPath === 'number' &&\n    path.at(-2) === 'marks' &&\n    typeof path.at(-3) === 'number' &&\n    path.at(-4) === 'children' &&\n    typeof path.at(-5) === 'number'\n  ) {\n    return false\n  }\n  // Or if it's [number].markDefs[number].href it's likely a PortableTextLink: https://github.com/portabletext/types/blob/e54eb24f136d8efd51a46c6a190e7c46e79b5380/src/portableText.ts#L163\n  if (\n    endPath === 'href' &&\n    typeof path.at(-2) === 'number' &&\n    path.at(-3) === 'markDefs' &&\n    typeof path.at(-4) === 'number'\n  ) {\n    return false\n  }\n  // Otherwise we have to deal with special properties of PortableTextBlock, and we can't confidently know if it's actually a `_type: 'block'` array item or not.\n  // All we know is that if it is indeed a block, and we encode the strings on these keys it'll for sure break the PortableText rendering and thus we skip encoding.\n  if (typeof endPath === 'string' && typeof path.at(-2) === 'number') {\n    // https://github.com/portabletext/types/blob/e54eb24f136d8efd51a46c6a190e7c46e79b5380/src/portableText.ts#L48-L58\n    if (endPath === 'style' || endPath === 'listItem') {\n      return false\n    }\n  }\n\n  return true\n}\n\nexport type Transcoder = (\n  input: string,\n  sourceDocument: ContentSourceMapDocuments[number],\n  sourcePath: PathSegment[]\n) => string\n\nconst TRUNCATE_LENGTH = 20\n\n/**\n * @internal\n */\nexport function createTranscoder(\n  studioUrl: PreviewKitClientConfig['studioUrl'],\n  encodeSourceMapAtPath?: PreviewKitClientConfig['encodeSourceMapAtPath'],\n  logger?: Logger\n): {\n  report: Record<\n    'encoded' | 'skipped',\n    { path: string; length: number; value: string }[]\n  >\n  transcode: Transcoder\n  walk: (input: ContentSourceMapQueryResponse) => ContentSourceMapQueryResponse\n} {\n  // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n  const createEditLink = defineEditLink(studioUrl!)\n  const report: Record<\n    'encoded' | 'skipped',\n    { path: string; length: number; value: string }[]\n  > = { encoded: [], skipped: [] }\n\n  const transcode = (\n    input: string,\n    sourceDocument: ContentSourceMapDocuments[number],\n    sourcePath: PathSegment[]\n  ): string => {\n    // Allow userland to control when to opt-out of encoding\n    if (\n      (typeof encodeSourceMapAtPath === 'function'\n        ? encodeSourceMapAtPath({ path: sourcePath, filterDefault })\n        : filterDefault({ path: sourcePath, filterDefault })) === false\n    ) {\n      if (logger) {\n        report.skipped.push({\n          path: prettyPathForLogging(sourcePath),\n          value: `${input.slice(0, TRUNCATE_LENGTH)}${\n            input.length > TRUNCATE_LENGTH ? '...' : ''\n          }`,\n          length: input.length,\n        })\n      }\n      return input\n    }\n\n    if (logger) {\n      report.encoded.push({\n        path: prettyPathForLogging(sourcePath),\n        value: `${input.slice(0, TRUNCATE_LENGTH)}${\n          input.length > TRUNCATE_LENGTH ? '...' : ''\n        }`,\n        length: input.length,\n      })\n    }\n\n    return vercelStegaCombine(\n      input,\n      {\n        origin: 'sanity.io',\n        href: createEditLink(sourceDocument, sourcePath),\n      },\n      'auto'\n    )\n  }\n  return {\n    report,\n    transcode,\n    walk: (input: ContentSourceMapQueryResponse) => {\n      // Clear previous reports\n      report.encoded.length = 0\n      report.skipped.length = 0\n      // Start the recursive machinery\n      return encode(input, (value, sourceDocument, path) =>\n        transcode(value, sourceDocument, parseNormalisedJsonPath(path))\n      )\n    },\n  }\n}\n\nfunction prettyPathForLogging(path: PathSegment[]): string {\n  return path\n    .map((segment, index) =>\n      typeof segment === 'number'\n        ? `[${segment}]`\n        : index > 0\n        ? `.${segment}`\n        : segment\n    )\n    .join('')\n}\n","/**\n * Creates a custom `httpRequest` handler for `SanityClient`, that\n * includes a middleware that handles source maps and stega encoding.\n */\nimport {\n  type HttpRequest,\n  requester as originalRequester,\n  type RequestOptions,\n} from '@sanity/client'\nimport isPlainObject from 'lodash.isplainobject'\nimport invariant from 'tiny-invariant'\n\nimport { createTranscoder } from './transcode'\nimport type {\n  ContentSourceMapQueryResponse,\n  PreviewKitClientConfig,\n} from './types'\n\ntype TranscodeResponseConfig = Pick<\n  PreviewKitClientConfig,\n  'studioUrl' | 'encodeSourceMapAtPath' | 'logger'\n>\n\nfunction transcodeResponse({\n  studioUrl,\n  encodeSourceMapAtPath,\n  logger,\n}: TranscodeResponseConfig) {\n  // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n  const transcoder = createTranscoder(studioUrl, encodeSourceMapAtPath, logger!)\n  return {\n    onResponse: (response: unknown) => {\n      if (!isBodyResponse(response)) {\n        return response\n      }\n\n      if (\n        Array.isArray(response.body) ||\n        typeof response.body === 'string' ||\n        isPlainObject(response.body)\n      ) {\n        if (!isContentSourceMapBody(response.body)) {\n          if (logger) {\n            logger?.error?.(\n              '[@sanity/preview-kit]: Missing Content Source Map from response body',\n              response.body\n            )\n          }\n          return response\n        }\n\n        const body = transcoder.walk(response.body)\n\n        if (logger) {\n          const isSkipping = transcoder.report.skipped.length\n          const isEncoding = transcoder.report.encoded.length\n          if (isSkipping || isEncoding) {\n            // eslint-disable-next-line @typescript-eslint/no-extra-semi\n            ;(logger?.groupCollapsed || logger.log)?.(\n              '[@sanity/preview-kit]: Stega encoding source map into result'\n            )\n            logger.log?.(\n              `[@sanity/preview-kit]: Paths encoded: ${transcoder.report.encoded.length}, skipped: ${transcoder.report.skipped.length}`\n            )\n          }\n          if (transcoder.report.encoded.length > 0) {\n            logger?.log?.(`[@sanity/preview-kit]: Table of encoded paths`)\n            ;(logger?.table || logger.log)?.(transcoder.report.encoded)\n          }\n          if (transcoder.report.skipped.length > 0) {\n            const skipped = new Set<string>()\n            for (const { path } of transcoder.report.skipped) {\n              skipped.add(path.replace(/\\[\\d+\\]/g, '[]'))\n            }\n            logger?.log?.(`[@sanity/preview-kit]: List of skipped paths`, [\n              ...skipped.values(),\n            ])\n          }\n\n          if (isSkipping || isEncoding) {\n            logger?.groupEnd?.()\n          }\n        }\n\n        return { ...response, body }\n      }\n\n      return response\n    },\n  }\n}\n\n/** @internal */\nexport function createHttpRequest({\n  studioUrl,\n  encodeSourceMapAtPath,\n  logger,\n}: Pick<\n  PreviewKitClientConfig,\n  'studioUrl' | 'encodeSourceMapAtPath' | 'logger'\n>): HttpRequest {\n  invariant(studioUrl, 'Missing studioUrl in client config')\n  const superRequester = originalRequester.clone()\n\n  // Apply the transcoder middleware\n  superRequester.use(\n    transcodeResponse({ studioUrl, encodeSourceMapAtPath, logger })\n  )\n\n  function httpRequest(\n    options: RequestOptions,\n    requester = superRequester\n  ): HttpRequest {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    return requester({ maxRedirects: 0, ...options } as any)\n  }\n\n  httpRequest.defaultRequester = superRequester\n\n  return httpRequest\n}\n\nfunction isBodyResponse(response: unknown): response is { body?: unknown } {\n  return typeof response === 'object' && response !== null\n}\n\n/** @alpha */\nexport function isContentSourceMapBody(\n  body: unknown\n): body is ContentSourceMapQueryResponse {\n  return typeof body === 'object' && body !== null && 'resultSourceMap' in body\n}\n","import { defineEditLink } from './editIntent'\nimport { encodeIntoResult } from './sourcemap'\nimport type { ContentSourceMapQueryResponse } from './types'\n\n/** @alpha */\nexport function mapToEditLinks(\n  response: ContentSourceMapQueryResponse,\n  studioUrl: string\n): unknown {\n  const createEditLink = defineEditLink(studioUrl)\n  return encodeIntoResult(response, (_, sourceDocument, path) => {\n    return createEditLink(sourceDocument, path)\n  })\n}\n","import { createClient as _createClient, SanityClient } from '@sanity/client'\n\nimport { createHttpRequest } from './request'\nimport type { PreviewKitClientConfig } from './types'\n\nexport type * from './mapToEditLinks'\nexport { mapToEditLinks } from './mapToEditLinks'\nexport type * from './types'\nexport type * from '@sanity/client'\n\n/**\n * @alpha\n */\nexport const createClient = (config: PreviewKitClientConfig): SanityClient => {\n  const {\n    encodeSourceMap = detectEnableSourceMap(),\n    encodeSourceMapAtPath,\n    studioUrl = detectStudioUrl(),\n    logger,\n    ...options\n  } = config\n\n  let shouldEncodeSourceMap = encodeSourceMap === true\n\n  // If encodeSourceMap is set to 'auto', then we need to check if we're running on Vercel and on a preview deployment\n  if (encodeSourceMap === 'auto') {\n    shouldEncodeSourceMap = isVercelPreviewEnvironment()\n  }\n\n  if (typeof encodeSourceMap === 'string' && encodeSourceMap !== 'auto') {\n    throw new Error(\n      `Invalid value for encodeSourceMap: ${encodeSourceMap}. Did you mean 'auto'?`\n    )\n  }\n\n  try {\n    if (shouldEncodeSourceMap && config.resultSourceMap !== false) {\n      logger?.debug?.(\n        '[@sanity/preview-kit]: Creating source map enabled client'\n      )\n      const httpRequest = createHttpRequest({\n        encodeSourceMapAtPath,\n        studioUrl,\n        logger,\n      })\n      return new SanityClient(httpRequest, {\n        ...options,\n        // Source maps by Content Lake are required in order to know where to insert the encoded source maps into strings\n        resultSourceMap: true,\n      })\n    }\n  } catch (err) {\n    // eslint-disable-next-line no-console\n    console.error(\n      '[@sanity/preview-kit]: Error creating client',\n      err,\n      'falling back to non-embedded sourcemap mode'\n    )\n  }\n  return _createClient(options)\n}\n\nfunction isVercelPreviewEnvironment() {\n  try {\n    // @ts-expect-error -- VERCEL_ENV is not a declared import.meta.env variable\n    return import.meta.env.VERCEL_ENV === 'preview'\n  } catch {\n    // ignore\n  }\n  try {\n    // eslint-disable-next-line no-process-env\n    return process.env.VERCEL_ENV === 'preview'\n  } catch {\n    // ignore\n  }\n  return false\n}\n\nfunction detectEnableSourceMap(): PreviewKitClientConfig['encodeSourceMap'] {\n  try {\n    // @ts-expect-error -- SANITY_SOURCE_MAP is not a declared import.meta.env variable\n    return import.meta.env.SANITY_SOURCE_MAP === 'true' || 'auto'\n  } catch {\n    // ignore\n  }\n  try {\n    // eslint-disable-next-line no-process-env\n    return process.env.SANITY_SOURCE_MAP === 'true' || 'auto'\n  } catch {\n    // ignore\n  }\n  return 'auto'\n}\n\n// eslint-disable-next-line consistent-return\nfunction detectStudioUrl() {\n  try {\n    // @ts-expect-error -- SANITY_STUDIO_URL is not a declared import.meta.env variable\n    return import.meta.env.SANITY_STUDIO_URL\n  } catch {\n    // ignore\n  }\n  try {\n    // eslint-disable-next-line no-process-env\n    return process.env.SANITY_STUDIO_URL\n  } catch {\n    // ignore\n  }\n}\n"],"names":["defineEditLink","_studioUrl","studioUrl","replace","sourceDocument","path","concat","_id","encodeJsonPathToUriComponent","sourcePath","Array","isArray","parseNormalisedJsonPath","encodeURIComponent","map","key","i","join","filterDefault","_ref","endPath","at","startsWith","TRUNCATE_LENGTH","createTranscoder","encodeSourceMapAtPath","logger","createEditLink","report","encoded","skipped","transcode","input","push","prettyPathForLogging","value","slice","length","vercelStegaCombine","origin","href","walk","encode","segment","index","transcodeResponse","_ref2","transcoder","onResponse","response","_a","_b","_c","_d","_e","_f","_g","isBodyResponse","body","isPlainObject","isContentSourceMapBody","error","call","isSkipping","isEncoding","groupCollapsed","log","table","Set","add","values","groupEnd","createHttpRequest","_ref3","invariant","superRequester","originalRequester","clone","use","httpRequest","options","requester","arguments","undefined","maxRedirects","defaultRequester","mapToEditLinks","encodeIntoResult","_","createClient","config","encodeSourceMap","detectEnableSourceMap","detectStudioUrl","shouldEncodeSourceMap","isVercelPreviewEnvironment","Error","resultSourceMap","debug","SanityClient","err","console","_createClient","VERCEL_ENV","process","env","SANITY_SOURCE_MAP","SANITY_STUDIO_URL"],"mappings":"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"}